<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrier Helper</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>Carrier Helper</h1>
    <p class="subtitle">Track your mail carrier shifts with ease</p>

    <nav class="view-nav">
      <button id="nav-time-entries" class="nav-btn active">Time Entries</button>
      <button id="nav-hours-view"   class="nav-btn">Hours View</button>
      <button id="nav-data-viewer"  class="nav-btn">Data Viewer</button>
    </nav>

    <div class="cloud-sync-bar">
      <button
        id="cloudSyncLoginBtn"
        class="btn-cloud-sync"
        style="display: none"
        onclick="CloudSyncModule.openAuthModal()"
      >‚òÅÔ∏è Sign In to Sync</button>
      <div id="cloudSyncUserStatus" class="cloud-user-status" style="display: none">
        <span id="cloudSyncUserEmail" class="user-email"></span>
        <span id="syncStatusIndicator" class="sync-status" style="display: none"></span>
        <button onclick="CloudSyncModule.signOut()" class="btn-cloud-signout">Sign Out</button>
      </div>
      <div id="syncErrorDetail" class="sync-error-detail" style="display: none"></div>
    </div>
  </header>

  <!-- Cloud Sync Login Modal -->
  <div id="cloudSyncModal" class="modal" style="display: none">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚òÅÔ∏è Cloud Sync</h3>
        <button onclick="CloudSyncModule.closeAuthModal()" class="modal-close" title="Close">‚úï</button>
      </div>
      <p class="modal-description">
        Sign in to sync your time entries across all your browsers and devices automatically.
      </p>
      <div class="form-group">
        <label for="authEmail">Email:</label>
        <input type="email" id="authEmail" class="auth-input" placeholder="you@example.com" />
      </div>
      <div class="form-group">
        <label for="authPassword">Password:</label>
        <input type="password" id="authPassword" class="auth-input" placeholder="Password" />
      </div>
      <div id="authError" class="auth-error" style="display: none"></div>
      <div class="auth-actions">
        <button id="authSignInBtn" onclick="CloudSyncModule.handleSignIn()" class="btn-primary">Sign In</button>
        <button id="authSignUpBtn" onclick="CloudSyncModule.handleSignUp()" class="btn-secondary">Create Account</button>
      </div>
      <p class="auth-note">
        Your data is stored privately in the cloud and only accessible with your account.
      </p>
    </div>
  </div>

  <main>
    <!-- Time Entries View -->
    <div id="time-entries-view">
      <section class="clock-panel">
        <div class="status-display">
          <span id="status-label">Status:</span>
          <span id="status-value" class="status-out">Clocked Out</span>
        </div>
        <div class="current-time" id="current-time">--:--:--</div>
        <button id="clock-btn" class="btn btn-in">Clock In</button>
      </section>

      <!-- Current shift (in-progress) or Last Shift (most recent completed) -->
      <section class="entries-panel" id="current-shift-panel">
        <div class="entries-header">
          <h2 id="current-shift-title">Current Shift</h2>
          <button class="btn-collapse" id="current-shift-toggle" aria-expanded="true" title="Collapse section">‚ñº</button>
        </div>
        <div class="panel-body" id="current-shift-body-wrapper">
          <div class="table-wrapper">
            <table id="current-shift-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Clock In</th>
                  <th>Clock Out</th>
                  <th>Duration</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="current-shift-body">
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Recent completed shifts -->
      <section class="entries-panel" id="previous-shifts-panel">
        <div class="entries-header">
          <h2>Previous Shifts</h2>
          <div class="entries-header-actions">
            <button class="btn-collapse" id="previous-shifts-toggle" aria-expanded="true" title="Collapse section">‚ñº</button>
          </div>
        </div>
        <div class="panel-body" id="previous-shifts-body-wrapper">
          <div class="table-wrapper">
            <table id="previous-shifts-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Date</th>
                  <th>Clock In</th>
                  <th>Clock Out</th>
                  <th>Duration</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="entries-body">
              </tbody>
            </table>
            <p id="empty-msg" class="empty-msg">No recent shifts to show.</p>
          </div>
        </div>
      </section>
    </div>

    <!-- Hours View -->
    <div id="hours-view" style="display: none">
      <section class="entries-panel">
        <div class="entries-header">
          <h2>‚è±Ô∏è Hours Summary</h2>
        </div>

        <!-- Period type selector -->
        <nav class="hv-period-nav">
          <button id="hv-period-week"  class="btn-sub-tab active">üìÖ Week</button>
          <button id="hv-period-month" class="btn-sub-tab">üìÜ Month</button>
          <button id="hv-period-year"  class="btn-sub-tab">üìä Year</button>
        </nav>

        <!-- Navigation row -->
        <div class="hv-nav-row">
          <button id="hv-prev-btn" class="btn-nav-week">‚Äπ Prev</button>
          <div class="hv-nav-center">
            <span id="hv-period-label" class="dv-week-label"></span>
            <!-- Week picker: date input + This Week button -->
            <div id="hv-week-picker" class="hv-picker-row">
              <input type="date" id="hv-date-picker" class="hv-date-picker" title="Jump to date" />
              <button id="hv-this-week-btn" class="btn-jump">This Week</button>
            </div>
            <!-- Month picker: This Month button + year buttons + month grid -->
            <div id="hv-month-picker" style="display:none">
              <button id="hv-this-month-btn" class="btn-jump hv-this-period-btn">This Month</button>
              <div id="hv-month-year-btns" class="hv-year-btns"></div>
              <div id="hv-month-grid" class="hv-month-grid"></div>
            </div>
            <!-- Year picker: dynamically generated year buttons -->
            <div id="hv-year-picker" style="display:none">
              <div id="hv-year-btns" class="hv-year-btns"></div>
            </div>
          </div>
          <button id="hv-next-btn" class="btn-nav-week">Next ‚Ä∫</button>
        </div>

        <!-- Summary cards -->
        <div class="hv-summary-cards" id="hv-summary-cards"></div>

        <!-- Breakdown table -->
        <div class="table-wrapper">
          <table class="hv-table" id="hv-table"></table>
          <p id="hv-empty-msg" class="empty-msg" style="display:none">No entries for this period.</p>
        </div>
      </section>
    </div>

    <!-- Data Viewer View -->
    <div id="data-viewer-view" style="display: none">
      <!-- Sub-tab navigation within Data Viewer -->
      <nav class="dv-sub-nav">
        <button id="dv-sub-time-entries" class="btn-sub-tab active">Time Entries</button>
        <button id="dv-sub-meta-data" class="btn-sub-tab">Meta Data</button>
      </nav>

      <!-- Time Entries sub-view (existing data viewer) -->
      <div id="dv-time-entries-sub">
      <section class="entries-panel">
        <div class="entries-header">
          <h2>All Time Entries</h2>
          <button id="dv-select-all-btn" class="btn-select-all">‚òë Select All</button>
        </div>

        <!-- View mode toggle -->
        <div class="dv-view-mode-row">
          <button id="dv-mode-week" class="btn-mode-toggle active">üìÖ Week View</button>
          <button id="dv-mode-range" class="btn-mode-toggle">üìÜ Custom Range</button>
        </div>

        <!-- Week navigation (shown in week mode) -->
        <div class="dv-week-nav" id="dv-week-nav-row">
          <button id="dv-prev-week" class="btn-nav-week">‚Äπ Prev Week</button>
          <div class="dv-week-center">
            <span id="dv-week-label" class="dv-week-label"></span>
            <div class="dv-jump-to-date">
              <input type="date" id="dv-date-jump" title="Jump to date" />
              <button id="dv-date-jump-btn" class="btn-jump">Go</button>
            </div>
          </div>
          <button id="dv-next-week" class="btn-nav-week">Next Week ‚Ä∫</button>
        </div>

        <!-- Custom range row (shown in custom range mode) -->
        <div class="dv-custom-range-row" id="dv-custom-range-row" style="display:none">
          <div class="dv-range-inputs">
            <label>From: <input type="date" id="dv-range-start" /></label>
            <span class="dv-range-sep">‚Äì</span>
            <label>To: <input type="date" id="dv-range-end" /></label>
            <button id="dv-range-apply-btn" class="btn-jump">Apply</button>
          </div>
          <span id="dv-range-label" class="dv-week-label"></span>
        </div>

        <div class="table-wrapper">
          <table id="dv-table">
            <thead>
              <tr>
                <th class="dv-check-col"></th>
                <th>#</th>
                <th>Date</th>
                <th>Clock In</th>
                <th>Clock Out</th>
                <th>Duration</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="dv-body">
              <!-- Rows injected by app.js -->
            </tbody>
          </table>
          <p id="dv-empty-msg" class="empty-msg">No entries yet.</p>
        </div>
      </section>
      </div><!-- /dv-time-entries-sub -->

      <!-- Meta Data sub-view -->
      <div id="dv-meta-data-sub" style="display: none">
        <section class="entries-panel">
          <div class="entries-header">
            <h2>üìã USPS Pay Scale Settings</h2>
          </div>
          <p class="meta-description">
            Configure your USPS mail carrier pay rates and thresholds. These values are used
            to calculate expected pay from your time entries. Defaults are based on the NALC
            National Agreement for City Letter Carriers.
          </p>

          <div class="meta-form" id="meta-data-form">
            <!-- Pay Rates Section -->
            <div class="meta-section">
              <h3>üí∞ Pay Rates</h3>
              <div class="meta-field">
                <label for="meta-baseHourlyRate">Base Hourly Rate ($/hr)</label>
                <input type="number" id="meta-baseHourlyRate" step="0.01" min="0" />
                <span class="meta-hint">Your regular hourly wage (Grade 1, Step BB default: $23.49)</span>
              </div>
              <div class="meta-field">
                <label for="meta-nightDifferentialRate">Night Differential (additional $/hr)</label>
                <input type="number" id="meta-nightDifferentialRate" step="0.01" min="0" />
                <span class="meta-hint">Extra pay per hour for night work (default: $1.08)</span>
              </div>
            </div>

            <!-- Overtime Multipliers Section -->
            <div class="meta-section">
              <h3>‚è±Ô∏è Overtime Multipliers</h3>
              <div class="meta-field">
                <label for="meta-overtimeMultiplier">Overtime Rate (√ó base rate)</label>
                <input type="number" id="meta-overtimeMultiplier" step="0.01" min="1" />
                <span class="meta-hint">Applied after daily/weekly overtime thresholds (default: 1.5√ó)</span>
              </div>
              <div class="meta-field">
                <label for="meta-penaltyOvertimeMultiplier">Penalty Overtime Rate (√ó base rate)</label>
                <input type="number" id="meta-penaltyOvertimeMultiplier" step="0.01" min="1" />
                <span class="meta-hint">Applied after penalty overtime thresholds (default: 2.0√ó)</span>
              </div>
              <div class="meta-field">
                <label for="meta-sundayPremiumPercent">Sunday Premium (%)</label>
                <input type="number" id="meta-sundayPremiumPercent" step="1" min="0" max="100" />
                <span class="meta-hint">Additional percentage of base rate for Sunday hours (default: 25%)</span>
              </div>
            </div>

            <!-- Overtime Thresholds Section -->
            <div class="meta-section">
              <h3>üìä Overtime Thresholds</h3>
              <div class="meta-field-row">
                <div class="meta-field">
                  <label for="meta-dailyOvertimeThresholdHours">Daily OT Threshold (hours)</label>
                  <input type="number" id="meta-dailyOvertimeThresholdHours" step="0.5" min="0" />
                  <span class="meta-hint">Overtime starts after this many hours/day (default: 8)</span>
                </div>
                <div class="meta-field">
                  <label for="meta-dailyPenaltyOTThresholdHours">Daily Penalty OT Threshold (hours)</label>
                  <input type="number" id="meta-dailyPenaltyOTThresholdHours" step="0.5" min="0" />
                  <span class="meta-hint">Penalty overtime after this many hours/day (default: 10)</span>
                </div>
              </div>
              <div class="meta-field-row">
                <div class="meta-field">
                  <label for="meta-weeklyOvertimeThresholdHours">Weekly OT Threshold (hours)</label>
                  <input type="number" id="meta-weeklyOvertimeThresholdHours" step="0.5" min="0" />
                  <span class="meta-hint">Overtime starts after this many hours/week (default: 40)</span>
                </div>
                <div class="meta-field">
                  <label for="meta-weeklyPenaltyOTThresholdHours">Weekly Penalty OT Threshold (hours)</label>
                  <input type="number" id="meta-weeklyPenaltyOTThresholdHours" step="0.5" min="0" />
                  <span class="meta-hint">Penalty overtime after this many hours/week (default: 56)</span>
                </div>
              </div>
            </div>

            <!-- Night Differential Time Window Section -->
            <div class="meta-section">
              <h3>üåô Night Differential Window</h3>
              <div class="meta-field-row">
                <div class="meta-field">
                  <label for="meta-nightDiffStartTime">Night Start Time</label>
                  <input type="time" id="meta-nightDiffStartTime" />
                  <span class="meta-hint">Night hours begin (default: 6:00 PM)</span>
                </div>
                <div class="meta-field">
                  <label for="meta-nightDiffEndTime">Night End Time</label>
                  <input type="time" id="meta-nightDiffEndTime" />
                  <span class="meta-hint">Night hours end (default: 6:00 AM)</span>
                </div>
              </div>
            </div>

            <div class="meta-actions">
              <button id="meta-save-btn" class="btn btn-primary">üíæ Save Changes</button>
              <button id="meta-reset-btn" class="btn btn-secondary">‚Ü©Ô∏è Reset to Defaults</button>
            </div>
            <div id="meta-save-status" class="meta-save-status" style="display: none"></div>
          </div>
        </section>
      </div><!-- /dv-meta-data-sub -->

      <!-- Data Management (always visible regardless of active sub-tab) -->
      <section class="entries-panel" id="data-mgmt-panel">
        <div class="entries-header">
          <h2>Data Management</h2>
          <button class="btn-collapse collapsed" id="data-mgmt-toggle" aria-expanded="false" title="Collapse section">‚ñº</button>
        </div>
        <div class="panel-body collapsed" id="data-mgmt-body">
          <div class="data-mgmt-sections">
            <div class="data-mgmt-section">
              <h3>Export Data</h3>
              <div class="export-buttons">
                <button id="export-btn" class="btn btn-export">üì• Export Time Entries to CSV</button>
                <button id="export-metadata-btn" class="btn btn-export">üìã Export Meta Data to CSV</button>
                <button id="export-all-btn" class="btn btn-export">üì¶ Export ALL Data to CSV</button>
                <button id="export-range-btn" class="btn btn-export-range">üìÖ Export Date Range to CSV</button>
              </div>
              <div class="export-range-form" id="export-range-form" style="display:none">
                <div class="export-range-inputs">
                  <label>From: <input type="date" id="export-range-start" /></label>
                  <span class="dv-range-sep">‚Äì</span>
                  <label>To: <input type="date" id="export-range-end" /></label>
                </div>
                <div class="export-range-actions">
                  <button id="export-range-confirm-btn" class="btn-jump">üì• Export</button>
                  <button id="export-range-cancel-btn" class="btn-secondary-sm">Cancel</button>
                </div>
              </div>
              <p class="mgmt-note">
                <strong>Export Time Entries:</strong> Downloads the entries shown in the current date view. If entries are selected, only those are exported.<br>
                <strong>Export Meta Data:</strong> Downloads your USPS pay scale settings.<br>
                <strong>Export ALL Data:</strong> Downloads all time entries and meta data in a single file.<br>
                <strong>Export Date Range:</strong> Downloads time entries between two dates you specify.
              </p>
            </div>

            <div class="data-mgmt-section">
              <h3>Import Data</h3>
              <div class="import-buttons">
                <button id="import-add-btn" class="btn btn-import-add">
                  <span class="btn-icon">‚ûï</span>
                  <span class="btn-text">
                    <strong>Add to Existing</strong>
                    <small>Merge with current data</small>
                  </span>
                </button>
                <button id="import-replace-btn" class="btn btn-import-replace">
                  <span class="btn-icon">üîÑ</span>
                  <span class="btn-text">
                    <strong>Replace All</strong>
                    <small>Delete &amp; replace all data</small>
                  </span>
                </button>
              </div>
              <p class="mgmt-note">
                Automatically detects data type (time entries, meta data, or both).<br>
                <strong>Add to Existing:</strong> Merges the CSV with your current data (duplicates skipped).<br>
                <strong>Replace All:</strong> ‚ö†Ô∏è Permanently deletes matching data and replaces with the CSV file.
              </p>
              <!-- Hidden file input for import -->
              <input type="file" id="import-file-input" accept=".csv" style="display: none" />
            </div>

            <div class="data-mgmt-section">
              <h3>Delete Local Data</h3>
              <button id="delete-all-btn" class="btn btn-delete-all">üóë Delete All Local Data</button>
              <p class="mgmt-note">‚ö†Ô∏è Permanently deletes <strong>all</strong> locally stored time entries. This cannot be undone.</p>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="site-footer">
    <p>Created by <a href="https://www.avinzarlez.com/" target="_blank" rel="noopener noreferrer">Avin Zarlez</a> &nbsp;|&nbsp; <a href="https://github.com/AvinZarlez/carrier-helper" target="_blank" rel="noopener noreferrer">View this project on GitHub</a></p>
  </footer>

  <!-- Edit Entry Modal -->
  <div id="editEntryModal" class="modal" style="display: none">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit Entry</h3>
        <button onclick="closeEditModal()" class="modal-close" title="Close">‚úï</button>
      </div>
      <div class="form-group">
        <label for="editClockIn">Clock In:</label>
        <input type="datetime-local" id="editClockIn" class="auth-input" step="1" />
      </div>
      <div class="form-group">
        <label for="editClockOut">Clock Out <span class="auth-note">(leave empty if in progress)</span>:</label>
        <input type="datetime-local" id="editClockOut" class="auth-input" step="1" />
      </div>
      <div class="form-group">
        <label for="editNotes">Notes:</label>
        <textarea id="editNotes" class="auth-input edit-textarea" rows="3" placeholder="Optional notes‚Ä¶"></textarea>
      </div>
      <div id="editError" class="auth-error" style="display: none"></div>
      <div class="auth-actions">
        <button id="editSaveBtn" onclick="saveEditEntry()" class="btn-primary">Save</button>
        <button onclick="closeEditModal()" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Multi-select action banner (data viewer) -->
  <div id="dv-selection-banner" class="dv-selection-banner" style="display:none">
    <span id="dv-selection-count" class="dv-selection-count"></span>
    <div class="dv-selection-actions">
      <button id="dv-download-selected-btn" class="btn-selection-download">‚¨á Download Selected</button>
      <button id="dv-delete-selected-btn" class="btn-selection-delete">üóë Delete Selected</button>
      <button id="dv-deselect-all-btn" class="btn-selection-clear">‚úï Deselect All</button>
    </div>
  </div>

  <!-- Application Scripts (load order matters) -->
  <script src="js/common.js"></script>
  <script src="js/time-entries.js"></script>
  <script src="js/data-viewer.js"></script>
  <script src="js/meta-data.js"></script>
  <script src="js/hours-view.js"></script>
  <script src="js/app.js"></script>
  <!-- Firebase SDK (only active when firebase-config.js has a non-empty apiKey) -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/cloud-sync.js"></script>
</body>
</html>
